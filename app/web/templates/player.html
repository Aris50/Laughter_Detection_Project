<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Experiment Player</title>
    <style>
        body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; }
        h1 { color: white; font-family: sans-serif; position: absolute; top: 20px; }
    </style>
</head>
<body>
    <div id="playlist-data" data-ids='{{ playlist | tojson | safe }}' style="display:none;"></div>

    <div id="player"></div>

    <script>
        // 1. Load YouTube IFrame API
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // 2. Retrieve Playlist Data safely
        var player;
        var dataElement = document.getElementById('playlist-data');
        var playlistIds = JSON.parse(dataElement.getAttribute('data-ids'));
        var timerInterval = null;

        // 3. YouTube API Callback
        // This function is called automatically by the YouTube API when it loads.
        // It is NOT called by our code directly.
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                playerVars: {
                    'playsinline': 1,
                    'controls': 0,
                    'rel': 0,
                    // vital for localhost playback to work
                    'origin': window.location.origin
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        function onPlayerReady(event) {
            event.target.loadPlaylist(playlistIds);
        }

        function onPlayerStateChange(event) {
            var index = player.getPlaylistIndex();
            var currentId = playlistIds[index];

            if (event.data == YT.PlayerState.PLAYING) {
                startReportingTime(currentId);
            } else {
                stopReportingTime(currentId, event.data);
            }
        }

        function startReportingTime(vidId) {
            if (timerInterval) clearInterval(timerInterval);

            // Send updates every 200ms
            timerInterval = setInterval(function() {
                var currentTime = player.getCurrentTime();
                notifyServer(vidId, true, "playing", currentTime);
            }, 200);
        }

        function stopReportingTime(vidId, state) {
            if (timerInterval) clearInterval(timerInterval);

            var statusMsg = (state == YT.PlayerState.ENDED) ? "ended" : "paused";

            // Check if entire playlist is done
            if (state == YT.PlayerState.ENDED && player.getPlaylistIndex() === playlistIds.length - 1) {
                statusMsg = "playlist_ended";
                document.body.innerHTML = "<h1>Session Complete. Thank you.</h1>";
            }

            // Send final "stopped" status
            notifyServer(vidId, false, statusMsg, player.getCurrentTime());
        }

        function notifyServer(vidId, isPlaying, statusMsg, time) {
            fetch('/status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    video_id: vidId,
                    playing: isPlaying,
                    status: statusMsg,
                    timestamp: time
                })
            });
        }

        function onPlayerError(event) {
            console.error("YouTube Player Error Code:", event.data);
        }
    </script>
</body>
</html>